<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주도성 발휘 To-Do 리스트</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX 컴파일러) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 폰트 정의 */
        @font-face {
            font-family: 'Paperlogy-Regular';
            src: url('Paperlogy-4Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Paperlogy-Bold';
            src: url('Paperlogy-7Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        /* 모든 요소에 기본 폰트 적용 */
        body, button, input, textarea, select, .font-sans {
            font-family: 'Paperlogy-Regular', sans-serif !important;
        }

        /* 타이틀 전용 폰트 클래스 */
        .font-title {
            font-family: 'Paperlogy-Bold', sans-serif !important;
        }

        /* 애니메이션 스타일 정의 */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 10s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }
        .animation-delay-4000 {
            animation-delay: 4s;
        }
        
        @keyframes float-up {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateY(-40px) translateX(5px) scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-80px) translateX(-5px) scale(0.5);
                opacity: 0;
            }
        }
        .animate-float-up {
            animation-name: float-up;
            animation-timing-function: ease-out;
            animation-fill-mode: forwards;
        }
        
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* 진짜 유리 느낌을 위한 CSS 클래스 */
        .real-glass {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.6);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .real-glass:hover {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
        }

        .real-glass-darker {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body class="bg-slate-100 overflow-x-hidden">
    <div id="root"></div>

    <!-- Firebase & React Logic -->
    <!-- 수정된 부분: type="text/babel" data-type="module" 로 변경하여 JSX와 import 구문을 동시에 지원하도록 함 -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        // 전역 변수가 정의되지 않았을 경우를 대비한 안전 장치 추가
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(firebaseConfigRaw);
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // React Logic
        const { useState, useEffect } = React;

        // --- 아이콘 컴포넌트 ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Heart = (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>;
        const Edit2 = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>;
        const Crown = (props) => <IconBase {...props}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></IconBase>;

        // --- 데이터 상수 ---
        const CATEGORIES = [
            { id: 'sit1', title: '상사의 지시가 불명확할 때' },
            { id: 'sit17', title: '담당자 대신 급한 업무 전화를 받았을 때' },
            { id: 'sit5', title: '할 일이 너무 많아 과부하 걸릴 때' },
            { id: 'sit6', title: '업무 중 예기치 못한 문제가 생겼을 때' },
            { id: 'sit7', title: '실수나 잘못을 저질렀을 때' },
            { id: 'sit8', title: '업무 프로세스가 비효율적일 때' },
            { id: 'sit12', title: '부정적인 피드백을 받았을 때' },
            { id: 'sit13', title: '새로운 업무를 맡게 되었을 때' },
        ];

        const THEME_STYLES = [
            { text: 'text-blue-900', tint: 'shadow-blue-500/20 hover:shadow-blue-500/40', activeBorder: 'border-blue-300' },
            { text: 'text-green-900', tint: 'shadow-green-500/20 hover:shadow-green-500/40', activeBorder: 'border-green-300' },
            { text: 'text-purple-900', tint: 'shadow-purple-500/20 hover:shadow-purple-500/40', activeBorder: 'border-purple-300' },
            { text: 'text-orange-900', tint: 'shadow-orange-500/20 hover:shadow-orange-500/40', activeBorder: 'border-orange-300' },
            { text: 'text-blue-900', tint: 'shadow-blue-500/20 hover:shadow-blue-500/40', activeBorder: 'border-blue-300' },
        ];

        const ROW_COLORS = [
            'bg-blue-400/20 border-blue-300/50 text-blue-900 shadow-blue-500/10', 
            'bg-green-400/20 border-green-300/50 text-green-900 shadow-green-500/10', 
            'bg-purple-400/20 border-purple-300/50 text-purple-900 shadow-purple-500/10', 
            'bg-orange-400/20 border-orange-300/50 text-orange-900 shadow-orange-500/10', 
            'bg-blue-400/20 border-blue-300/50 text-blue-900 shadow-blue-500/10', 
        ];

        // --- 컴포넌트 ---

        const FloatingHeartButton = ({ votes, onVote }) => {
            const [hearts, setHearts] = useState([]);

            const handleClick = () => {
                onVote();
                
                const newHeart = {
                    id: Date.now() + Math.random(),
                    color: ['text-red-500', 'text-pink-500', 'text-rose-400', 'text-purple-500', 'text-orange-400'][Math.floor(Math.random() * 5)],
                    left: Math.random() * 40 - 20,
                    animationDuration: 1 + Math.random() * 0.5,
                    scale: 0.8 + Math.random() * 0.4,
                };

                setHearts(prev => [...prev, newHeart]);

                setTimeout(() => {
                    setHearts(prev => prev.filter(h => h.id !== newHeart.id));
                }, 1500);
            };

            return (
                <div className="relative inline-block">
                    <button 
                        onClick={handleClick}
                        className={`
                            relative z-10 flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all duration-300
                            ${votes > 0 ? 'bg-pink-500/20 text-pink-600 border border-pink-300/50' : 'bg-white/30 text-slate-500 border border-white/50'}
                            hover:bg-pink-500/30 active:scale-95 backdrop-blur-md
                        `}
                    >
                        <Heart 
                            size={16} 
                            className={`transition-colors duration-300 ${votes > 0 ? 'fill-current' : ''}`} 
                        /> 
                        <span className="text-sm">{votes}</span>
                    </button>

                    {hearts.map(heart => (
                        <div
                            key={heart.id}
                            className={`absolute bottom-full left-1/2 pointer-events-none ${heart.color} animate-float-up`}
                            style={{
                                marginLeft: `${heart.left}px`,
                                animationDuration: `${heart.animationDuration}s`,
                                transform: `scale(${heart.scale})`
                            }}
                        >
                            <Heart fill="currentColor" size={20} />
                        </div>
                    ))}
                </div>
            );
        };

        const ProactiveTodoList = () => {
            const [user, setUser] = useState(null);
            const [todos, setTodos] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [inputValues, setInputValues] = useState({});
            const [editingId, setEditingId] = useState(null);
            const [editText, setEditText] = useState('');

            // 1. Firebase Auth 초기화
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // 2. Firestore 실시간 동기화
            useEffect(() => {
                if (!user) return;

                // 공용 컬렉션에서 데이터 가져오기
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'todos');
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const loadedTodos = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // 최신순 정렬 (Client-side Sorting)
                    loadedTodos.sort((a, b) => {
                        const timeA = a.createdAt?.seconds || 0;
                        const timeB = b.createdAt?.seconds || 0;
                        return timeB - timeA; // 내림차순 (최신이 위로)
                    });

                    setTodos(loadedTodos);
                }, (error) => {
                    console.error("Data fetch error:", error);
                });

                return () => unsubscribe();
            }, [user]);

            // To-Do 추가 핸들러
            const handleAddTodo = async (categoryId) => {
                const text = inputValues[categoryId];
                if (!text || text.trim() === '') return;
                if (!user) return;

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'todos'), {
                        categoryId,
                        text,
                        votes: 0,
                        createdAt: serverTimestamp(),
                        userId: user.uid
                    });
                    
                    setInputValues(prev => ({ ...prev, [categoryId]: '' }));
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            };

            const handleKeyDown = (e, categoryId) => {
                if (e.key === 'Enter' && !e.nativeEvent.isComposing) {
                    e.preventDefault();
                    handleAddTodo(categoryId);
                }
            };

            const handleInputChange = (categoryId, value) => {
                setInputValues(prev => ({ ...prev, [categoryId]: value }));
            };

            const handleVote = async (id) => {
                if (!user) return;
                const todoRef = doc(db, 'artifacts', appId, 'public', 'data', 'todos', id);
                try {
                    await updateDoc(todoRef, {
                        votes: increment(1)
                    });
                } catch (e) {
                    console.error("Error voting: ", e);
                }
            };

            const handleDelete = async (id) => {
                if (!user) return;
                if (!confirm("정말 삭제하시겠습니까?")) return;
                
                const todoRef = doc(db, 'artifacts', appId, 'public', 'data', 'todos', id);
                try {
                    await deleteDoc(todoRef);
                } catch (e) {
                    console.error("Error deleting: ", e);
                }
            };

            const saveEdit = async (id) => {
                if (!user) return;
                const todoRef = doc(db, 'artifacts', appId, 'public', 'data', 'todos', id);
                try {
                    await updateDoc(todoRef, {
                        text: editText
                    });
                    setEditingId(null);
                } catch (e) {
                    console.error("Error updating: ", e);
                }
            };

            const startEdit = (todo) => {
                setEditingId(todo.id);
                setEditText(todo.text);
            };

            const getCategoryInfo = (id) => {
                const index = CATEGORIES.findIndex(c => c.id === id);
                const category = CATEGORIES[index];
                const theme = THEME_STYLES[Math.floor(index / 2) % THEME_STYLES.length];
                const colorClass = ROW_COLORS[Math.floor(index / 2) % ROW_COLORS.length];
                
                return { ...category, ...theme, color: colorClass };
            };

            const currentCategoryInfo = selectedCategory ? getCategoryInfo(selectedCategory) : null;

            const renderTodoCard = (todo, isBest = false, uniqueKey = null) => (
                <div 
                    key={uniqueKey || todo.id} 
                    className={`
                        relative p-5 rounded-[1.5rem] transition-all
                        ${isBest 
                            ? 'real-glass-darker border-amber-300/50 shadow-[0_0_20px_rgba(251,191,36,0.3)]' 
                            : 'real-glass hover:-translate-y-1'
                        }
                    `}
                >
                    {isBest && (
                        <div className="absolute -top-3 -left-2 bg-gradient-to-r from-amber-400 to-orange-400 text-white text-[11px] font-bold px-3 py-1 rounded-full shadow-lg flex items-center gap-1 z-10 animate-pulse-slow border border-white/30">
                            <Crown size={14} fill="currentColor" /> BEST ANSWER
                        </div>
                    )}

                    {editingId === todo.id ? (
                        <div className="flex gap-2 items-center">
                            <input 
                            type="text" 
                            value={editText}
                            onChange={(e) => setEditText(e.target.value)}
                            className="flex-1 bg-white/30 border border-white/50 rounded-xl px-3 py-2 text-sm text-slate-800 focus:outline-none focus:bg-white/50 backdrop-blur-sm"
                            autoFocus
                            />
                            <button onClick={() => saveEdit(todo.id)} className="text-green-600 p-2 hover:bg-green-400/20 rounded-full"><Check size={18}/></button>
                            <button onClick={() => setEditingId(null)} className="text-red-500 p-2 hover:bg-red-400/20 rounded-full"><X size={18}/></button>
                        </div>
                    ) : (
                        <>
                            <div 
                                className={`text-base font-medium mb-4 leading-relaxed break-keep ${isBest ? 'text-slate-900 font-bold' : 'text-slate-800'}`} 
                                style={{ textWrap: 'balance' }}
                            >
                                {todo.text}
                            </div>
                            <div className="flex justify-between items-center">
                                <FloatingHeartButton 
                                    votes={todo.votes} 
                                    onVote={() => handleVote(todo.id)} 
                                />
                                
                                <div className="flex gap-3 text-slate-500">
                                    <button onClick={() => startEdit(todo)} className="hover:text-blue-600 transition-colors p-1 hover:bg-blue-400/20 rounded-full"><Edit2 size={16} /></button>
                                    <button onClick={() => handleDelete(todo.id)} className="hover:text-red-600 transition-colors p-1 hover:bg-red-400/20 rounded-full"><Trash2 size={16} /></button>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );

            return (
                <div className="min-h-screen pb-10 overflow-x-hidden relative selection:bg-pink-300 selection:text-white">
                    
                    <div className="fixed inset-0 bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 -z-30"></div>
                    <div className="fixed top-[-10%] left-[-10%] w-[60%] h-[50%] bg-blue-500 rounded-full mix-blend-multiply filter blur-[100px] opacity-40 animate-blob -z-20"></div>
                    <div className="fixed top-[-10%] right-[-10%] w-[60%] h-[50%] bg-purple-500 rounded-full mix-blend-multiply filter blur-[100px] opacity-40 animate-blob animation-delay-2000 -z-20"></div>
                    <div className="fixed bottom-[-20%] left-[20%] w-[70%] h-[60%] bg-pink-500 rounded-full mix-blend-multiply filter blur-[100px] opacity-40 animate-blob animation-delay-4000 -z-20"></div>

                    <div className="relative z-10 max-w-lg mx-auto h-full flex flex-col">
                        
                        <header className="p-6 pt-10 pb-6 flex items-center justify-between z-20">
                            {selectedCategory ? (
                                <button 
                                    onClick={() => setSelectedCategory(null)}
                                    className="p-3 real-glass rounded-[20px] text-slate-800 hover:scale-95 transition-transform active:bg-white/30"
                                >
                                    <ArrowLeft size={24} />
                                </button>
                            ) : (
                                <div className="p-2"></div>
                            )}
                            <div className="text-center">
                                <h1 className="text-4xl font-extrabold text-slate-800 tracking-tight leading-tight drop-shadow-sm font-title">주도성 To-Do</h1>
                            </div>
                            <div className="p-2 w-10"></div>
                        </header>

                        <main className="flex-1 px-5 pb-10 z-10">
                            
                            {selectedCategory === null ? (
                                /* 메인 화면 */
                                <>
                                    <div className="grid grid-cols-2 gap-4 mt-4">
                                    {CATEGORIES.map((category, index) => {
                                        const theme = THEME_STYLES[Math.floor(index / 2) % THEME_STYLES.length];
                                        return (
                                            <button
                                                key={category.id}
                                                onClick={() => setSelectedCategory(category.id)}
                                                className={`
                                                    real-glass
                                                    aspect-square p-4 rounded-[2rem] flex flex-col justify-center items-center text-center transition-all duration-300
                                                    hover:scale-[1.02] active:scale-[0.98]
                                                    ${theme.tint}
                                                    group
                                                `}
                                            >
                                                <span 
                                                    className={`relative z-10 font-bold text-xl leading-tight break-keep drop-shadow-sm ${theme.text}`}
                                                    style={{ textWrap: 'balance' }} 
                                                >
                                                    {category.title}
                                                </span>
                                            </button>
                                        );
                                    })}
                                    </div>
                                </>
                            ) : (
                                /* 상세 화면 */
                                <div className="animate-fadeIn flex flex-col h-full">
                                    <div className={`
                                        mb-6 p-6 rounded-[2.5rem] text-center real-glass
                                        ${currentCategoryInfo.activeBorder}
                                        ${currentCategoryInfo.tint}
                                    `}>
                                        <h2 
                                            className={`text-2xl font-bold leading-tight break-keep drop-shadow-sm ${currentCategoryInfo.text}`}
                                            style={{ textWrap: 'balance' }}
                                        >
                                            {currentCategoryInfo.title}
                                        </h2>
                                    </div>

                                    {(() => {
                                        const currentCategoryTodos = todos.filter(t => t.categoryId === currentCategoryInfo.id);
                                        const maxVotes = Math.max(...currentCategoryTodos.map(t => t.votes), 0);
                                        const bestTodo = maxVotes > 0 ? currentCategoryTodos.find(t => t.votes === maxVotes) : null;

                                        return bestTodo && (
                                            <div className="mb-6 animate-fadeIn">
                                                <div className="flex items-center gap-2 mb-2 px-4">
                                                    <Crown size={18} className="text-amber-600 fill-amber-400 drop-shadow-sm" />
                                                    <span className="text-sm font-bold text-amber-800 drop-shadow-sm">지금 가장 공감받는 답변</span>
                                                </div>
                                                {renderTodoCard(bestTodo, true, `best-${bestTodo.id}`)}
                                            </div>
                                        );
                                    })()}

                                    <div className="real-glass-darker rounded-[2rem] p-4 mb-6">
                                        <div className="flex items-center gap-2">
                                            <input
                                                type="text"
                                                placeholder="나만의 주도적인 행동을 적어보세요!"
                                                className="flex-1 bg-transparent border-none py-2 px-2 text-sm text-slate-800 placeholder-slate-600 focus:outline-none font-medium"
                                                value={inputValues[currentCategoryInfo.id] || ''}
                                                onChange={(e) => handleInputChange(currentCategoryInfo.id, e.target.value)}
                                                onKeyDown={(e) => handleKeyDown(e, currentCategoryInfo.id)}
                                            />
                                            <button
                                                onClick={() => handleAddTodo(currentCategoryInfo.id)}
                                                className="w-10 h-10 bg-blue-500/80 hover:bg-blue-600/90 text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-all backdrop-blur-sm border border-white/30"
                                            >
                                                <Plus size={20} />
                                            </button>
                                        </div>
                                    </div>

                                    <div className="space-y-4 pb-10">
                                        <div className="flex items-center justify-between ml-2 mb-2">
                                            {(() => {
                                                const count = todos.filter(t => t.categoryId === currentCategoryInfo.id).length;
                                                return (
                                                    <h3 className="text-sm font-bold text-slate-600">
                                                        등록된 아이디어 ({count})
                                                    </h3>
                                                );
                                            })()}
                                        </div>
                                        
                                        {(() => {
                                            const currentCategoryTodos = todos.filter(t => t.categoryId === currentCategoryInfo.id);

                                            return (
                                                <>
                                                    {currentCategoryTodos.map(todo => renderTodoCard(todo, false))}

                                                    {currentCategoryTodos.length === 0 && (
                                                        <div className="py-10 text-center opacity-60">
                                                            <p className="text-slate-500 mb-2 text-2xl">✨</p>
                                                            <p className="text-sm text-slate-600 font-medium">가장 먼저 아이디어를 남겨보세요!</p>
                                                        </div>
                                                    )}
                                                </>
                                            );
                                        })()}
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProactiveTodoList />);
    </script>
</body>
</html>
